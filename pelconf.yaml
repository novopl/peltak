# peltak configuration file
# See https://github.com/novopl/peltak for more information.
pelconf_version: '0'

# General project settings - used by many commands
src_dir: 'src'
src_path: 'src/peltak'
build_dir: '.build'
version_file: 'src/peltak/__init__.py'

# A list of py modules with commands that should be available for the project.
commands:
  - peltak.commands.docs
  - peltak.commands.git
  - peltak.commands.lint
  - peltak.commands.test
  - peltak.commands.version
  - peltak.extra.changelog
  - peltak.extra.gitflow
  - peltak.extra.pypi
  - peltak.extra.scripts

# Configure what gets deleted when running `peltak clean`
clean:
  exclude:
    - ".tox"
    - ".venv"


# Configure your docker registry and images within the project
docker:
  registry: docker.novocode.net


# Custom scripts
scripts:
  type-check:
    about: Run static type checks.
    files:
      paths: src/peltak
      include: "*.py"
    options:
      - name: ['--head']
        about: Pipe the output to 'head' to only see the first few results.
        is_flag: true
      - name: ['--count']
        about: Instead of showing the erros, display the number of errors detected.
        is_flag: true
    command: |
      set -e

      {{ 'mypy' | header }}
      pipenv run mypy --ignore-missing-imports {{ files | wrap_paths }} \
          {{ '| head' if opts.head else '' }} \
          {{ '| wc -l' if opts.count else '' }}

  lint:
    about: Run all linters (pep8, pylint).
    files:
      paths: ['src/peltak', 'test/unit']
      include: "*.py"
    command: |

      set -e
      {{ 'pep8' | header }}
      pipenv run pep8 --config ops/tools/pep8.ini {{ files | wrap_paths }};

      {{ 'pylint' | header }}
      pipenv run pylint --rcfile ops/tools/pylint.ini {{ files | wrap_paths }};

  checks:
    about: Run all checks (types, pep8, code style)
    files:
      paths:
        - src/peltak
        - test/unit
      include: "*.py"
      use_gitignore: true
    command: |
      set -e

      {{ 'mypy' | header }}
      pipenv run mypy --ignore-missing-imports {{ files | wrap_paths }}

      {{ 'pep8' | header }}
      pipenv run pep8 --config ops/tools/pep8.ini {{ files | wrap_paths }};

      {{ 'pylint' | header }}
      pipenv run pylint --rcfile ops/tools/pylint.ini {{ script.files.paths | wrap_paths }}

  tests:
    about: Run unit tests
    options:
      - name: ['--no-sugar']
        is_flag: true
        about: Disable pytest-sugar. Might be useful for CI runs.
    command: |
      set -e

      pipenv run pytest \
          -c ops/tools/pytest.ini \
          --cov-config=ops/tools/coverage.ini \
          --cov={{ conf.src_path }} \
          --cov-report=term \
          --cov-report=html:{{ conf.build_dir }}/coverage \
          {{ ctx.verbose | count_flag('v') }} \
          {{ '-p no:sugar' if opts.no_sugar else '' }} \
          test/unit

      {% set cov_path = proj_path(conf.build_dir, 'coverage/index.html') %}
      {{ cprint('<32>HTML report: <34>file://{}', cov_path) }}

  cov-core:
    about: Generate coverage report for peltak.core
    command: |
      set -e

      pipenv run pytest \
          -c ops/tools/pytest.ini \
          --cov-config=ops/tools/coverage.ini \
          --cov={{ conf.src_path }}/core \
          --cov-report=term \
          --cov-report=html:{{ conf.build_dir }}/coverage/core \
          test/unit

      {% set cov_path = proj_path(conf.build_dir, 'coverage/core/index.html') %}
      {{ cprint('<32>HTML report: <34>file://{}', cov_path) }}

  cov-extra:
    about: Generate coverage report for peltak.extra
    command: |
      set -e

      pipenv run pytest \
          -c ops/tools/pytest.ini \
          --cov-config=ops/tools/coverage.ini \
          --cov={{ conf.src_path }}/extra \
          --cov-report=term \
          --cov-report=html:{{ conf.build_dir }}/coverage/extra \
          test/unit

      {% set cov_path = proj_path(conf.build_dir, 'coverage/extra/index.html') %}
      {{ cprint('<32>HTML report: <34>file://{}', cov_path) }}

  cov-scripts:
    about: Generate coverage report for peltak.extra.scripts
    command: |
      pipenv run pytest \
          -c ops/tools/pytest.ini \
          --cov-config=ops/tools/coverage.ini \
          --cov={{ conf.src_path }}/extra/scripts \
          --cov-report=term \
          --cov-report=html:{{ conf.build_dir }}/coverage/scripts \
          test/unit

      {% set cov_path = proj_path(conf.build_dir, 'coverage/scripts/index.html') %}
      {{ cprint('<32>HTML report: <34>file://{}', cov_path) }}

  docs:
    about: Generate sphinx documentation
    command: |
      pipenv run sphinx-build \
          -b html \
          -d {{ conf.build_dir }}/docs \
          docs docs/html
