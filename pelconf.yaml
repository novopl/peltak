# peltak configuration file
# Visit https://novopl.github.io/peltak for more information
pelconf_version: '0'
commands:
  - peltak.extra.changelog
  - peltak.extra.git
  - peltak.extra.gitflow
  - peltak.extra.pypi
  - peltak.extra.version
  - peltak_todos


build_dir: .build
python_paths: ['src']

version:
  files:
    - pyproject.toml
    - src/peltak/__init__.py

clean:
  exclude: ['.venv']


changelog:
  tag_format: '{tag}:'
  tags:
    - tag: feature
      header: Features
    - tag: fix
      header: Fixes
    - tag: change
      header: Changes
    - tag: dev
      header: Dev tasks


scripts:
  test:
    root_cli: true
    about: Run tests
    options:
      - name: ['-k', '--kind']
        about: |
          What kind of tests should be ran (all/unit/e2e/doctest). If not given,
          then alltests will run.
        type: str
        default: all
      - name: ['-no-sugar']
        about: Disable pytest-sugar. Might be useful for CI runs.
        is_flag: true
      - name: ['--cov-xml']
        about: Generate junit XML coverage report. Useful for 3rd party integrations.
        is_flag: true
      - name: ['--cov']
        about: |
          What type of coverage should we define. Allowed values are:
          all/core/scripts/extra. Defaults to 'all'.
        type: str
        default: all
    command_file: ops/scripts/test.sh.j2

  check:
    root_cli: true
    about: Run all checks (types, pep8, code style)
    options:
      - name: ['--fix']
        is_flag: true
        about: Attempt to fix some of the failed checks (like isort).
    files:
      paths:
        - src/peltak
        - test/unit
      include: '*.py'
      use_gitignore: true
    command_file: ops/scripts/check.sh.j2

  check-commit:
    about: Perform all checks on files staged for commit
    files:
      paths:
        - src/peltak
        - test/unit
      include: '*.py'
      only_staged: true
      use_gitignore: true
    command_file: ops/scripts/check.sh.j2

  docs:
    root_cli: true
    about: Generate sphinx documentation
    options:
      - name: ['--recreate']
        about: Delete build and out directories before running.
        is_flag: true
      - name: ['--run-doctests']
        about: Also run all doctests.
        is_flag: true
    command_file: ops/scripts/docs.sh.j2

  pr-release:
    root_cli: true
    about: Create PR for the current release branch
    command: |
      gh pr create \
        --repo novopl/peltak \
        --title "Release: v$(peltak version --porcelain)" \
        --body "$(peltak changelog)"

  make-release:
    root_cli: true
    about: Create a release commit
    options:
      - name: ['-t', '--type']
        about: "Type of release to make: patch|minor|major. Defaults to 'patch'."
        type: str
        default: patch
    command: |
      {{ "-- <32>Creating <95>{}<32> release" | cprint(opts.type) }}

      poetry run peltak version bump {{ opts.type }}
      git add pyproject.toml src/ezfilter/__init__.py


      peltak changelog > .RELEASE_CHANGELOG
      echo "Release: $(peltak version --porcelain)\n" > .RELEASE_COMMIT_MSG
      peltak changelog > .RELEASE_COMMIT_MSG

      git commit -F .RELEASE_COMMIT_MSG
      peltak release tag -m "$(cat .RELEASE_CHANGELOG)"

      rm .RELEASE_CHANGELOG .RELEASE_COMMIT_MSG

  build:
    root_cli: true
    about: Build PyPI package.
    command: poetry build

  publish:
    root_cli: true
    about: Publish to PyPI repo
    options:
      - name: ['-r', '--repo']
        about: Target PyPI repository.
        type: str
      - name: ['-n', '--dry-run']
        about: Target PyPI repository.
        is_flag: true
      - name: ['-u', '--username']
        about: PyPI repo username
        type: str
      - name: ['-p', '--password']
        about: PyPI repo password
        type: str
    command: |
      poetry publish \
        --build \
        {{ ('-r ' + opts.repo) if opts.repo else '' }} \
        {{ '--dry-run' if opts.dry_run else '' }} \
        {{ '-u {}'.format(opts.username) if opts.username else '' }} \
        {{ '-p {}'.format(opts.password) if opts.password else '' }}

